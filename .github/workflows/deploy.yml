name: Deploy ARK to Server (DEPRECATED - Use deploy-ssh.yml)

# DISABLED: This workflow uses FTP which doesn't work with our setup
# Use deploy-ssh.yml instead (SSH + Tailscale tunnel)
on:
  workflow_dispatch:  # Manual trigger only - disabled from auto-run

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.12'

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better sync

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Create .env from Secrets
        run: |
          echo "# Auto-generated .env file from GitHub Secrets" > .env
          echo "# Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> .env
          echo "" >> .env
          echo "# Network Configuration" >> .env
          echo "ARK_NODE_IP=${{ secrets.ARK_NODE_IP }}" >> .env
          echo "ARK_DOMAIN=${{ secrets.ARK_DOMAIN }}" >> .env
          echo "" >> .env
          echo "# Default Credentials" >> .env
          echo "ARK_ADMIN_USER=${{ secrets.ARK_ADMIN_USER }}" >> .env
          echo "ARK_ADMIN_PASSWORD=${{ secrets.ARK_ADMIN_PASSWORD }}" >> .env
          echo "" >> .env
          echo "# Service Credentials" >> .env
          echo "FILEBROWSER_ADMIN_TOKEN=${{ secrets.FILEBROWSER_ADMIN_TOKEN }}" >> .env
          echo "CODE_SERVER_PASSWORD=${{ secrets.CODE_SERVER_PASSWORD }}" >> .env
          echo "CODE_SERVER_SUDO_PASSWORD=${{ secrets.CODE_SERVER_SUDO_PASSWORD }}" >> .env
          echo "" >> .env
          echo "# Tailscale (Optional)" >> .env
          if [ -n "${{ secrets.TAILSCALE_AUTHKEY }}" ]; then
            echo "TAILSCALE_AUTHKEY=${{ secrets.TAILSCALE_AUTHKEY }}" >> .env
          fi
          echo "" >> .env
          echo "# Timezone" >> .env
          echo "TZ=${{ secrets.TZ || 'America/Los_Angeles' }}" >> .env
          echo "" >> .env
          echo "# DO NOT EDIT - This file is auto-generated by GitHub Actions" >> .env
          echo "# To modify, update GitHub Secrets and re-run deployment" >> .env

      - name: Deploy via SFTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./
          server-dir: /opt/ark/
          exclude: |
            **/.git*
            **/vessel_secrets.env
            **/tests/**
            **/archive/**
            **/backups/**
            **/agents/marketing/venv/**
            **/node_modules/**
            **/__pycache__/**
            **/*.log
            **/.vscode/**
            **/.idea/**
            **/.cursor/**
            **/volumes/**
            **/data/**
            **/cache/**
            **/configs/*/
            !**/configs/homepage/
            **/configs/homepage/*.db
          dangerous-clean-slate: false
          dry-run: false

      - name: Execute Post-Deploy Script on Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            cd /opt/ark
            
            # Load environment variables
            if [ -f .env ]; then
              source .env
            fi
            
            # Pull latest Docker images
            echo "Pulling latest Docker images..."
            docker compose pull
            
            # Restart services with new code
            echo "Restarting services..."
            docker compose up -d --force-recreate
            
            # Wait for services to be healthy
            echo "Waiting for services to stabilize..."
            sleep 10
            
            # Check service status
            echo "Service status:"
            docker compose ps
            
            # Verify critical services
            echo "Verifying critical services..."
            docker compose ps | grep -q "Up" && echo "✓ Services running" || echo "⚠ Some services may have issues"
            
            # Log deployment
            echo "$(date -u +"%Y-%m-%d %H:%M:%S UTC") - GitHub Actions deployment completed" >> /opt/ark/.deploy.log

      - name: Purge Cloudflare Cache
        if: success()
        uses: jakejarvis/cloudflare-purge-action@master
        env:
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        with:
          purge: 'everything'  # Purge entire cache

      - name: Deployment Notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Deployment successful!"
            echo "Services restarted and Cloudflare cache purged"
          else
            echo "❌ Deployment failed!"
            echo "Check logs above for errors"
            exit 1
          fi
