name: Deploy ARK via SSH (Recommended)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy-ssh:
    name: Deploy via SSH (Recommended for Docker)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Create .env from Secrets
        run: |
          cat > .env << EOF
          # Auto-generated .env file from GitHub Secrets
          # Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          # Network Configuration
          ARK_NODE_IP=${{ secrets.ARK_NODE_IP }}
          ARK_DOMAIN=${{ secrets.ARK_DOMAIN }}
          
          # Default Credentials
          ARK_ADMIN_USER=${{ secrets.ARK_ADMIN_USER }}
          ARK_ADMIN_PASSWORD=${{ secrets.ARK_ADMIN_PASSWORD }}
          
          # Service Credentials
          FILEBROWSER_ADMIN_TOKEN=${{ secrets.FILEBROWSER_ADMIN_TOKEN }}
          CODE_SERVER_PASSWORD=${{ secrets.CODE_SERVER_PASSWORD }}
          CODE_SERVER_SUDO_PASSWORD=${{ secrets.CODE_SERVER_SUDO_PASSWORD }}
          
          # Tailscale (Optional)
          TAILSCALE_AUTHKEY=${{ secrets.TAILSCALE_AUTHKEY }}
          
          # Timezone
          TZ=${{ secrets.TZ || 'America/Los_Angeles' }}
          
          # DO NOT EDIT - Auto-generated by GitHub Actions
          EOF

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          source: "."
          target: "/opt/ark"
          strip_components: 0
          exclude: |
            .git
            .github
            vessel_secrets.env
            tests
            archive
            backups
            agents/marketing/venv
            node_modules
            __pycache__
            *.log
            .vscode
            .idea
            .cursor
            volumes
            data
            cache

      - name: Execute Deployment Commands
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            set -e
            cd /opt/ark
            
            echo "=== ARK Deployment Started ==="
            echo "Time: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            echo ""
            
            # Load environment variables
            if [ -f .env ]; then
              echo "Loading environment variables..."
              source .env
            else
              echo "âš  Warning: .env file not found"
            fi
            
            # Pull latest images
            echo "Pulling latest Docker images..."
            docker compose pull --quiet
            
            # Restart services
            echo "Restarting services..."
            docker compose up -d --force-recreate --remove-orphans
            
            # Wait for services to stabilize
            echo "Waiting for services to stabilize..."
            sleep 15
            
            # Health check
            echo ""
            echo "=== Service Status ==="
            docker compose ps
            
            # Verify critical services
            echo ""
            echo "=== Health Check ==="
            FAILED=$(docker compose ps --format json | jq -r '.[] | select(.State != "running") | .Name' 2>/dev/null || echo "")
            if [ -z "$FAILED" ]; then
              echo "âœ… All services running"
            else
              echo "âš  Some services may have issues:"
              echo "$FAILED"
            fi
            
            # Log deployment
            echo "$(date -u +"%Y-%m-%d %H:%M:%S UTC") - GitHub Actions deployment completed" >> /opt/ark/.deploy.log
            
            echo ""
            echo "=== Deployment Complete ==="

      - name: Purge Cloudflare Cache
        if: success()
        uses: jakejarvis/cloudflare-purge-action@master
        env:
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        with:
          purge: 'everything'

      - name: Deployment Summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… **Status:** Success" >> $GITHUB_STEP_SUMMARY
            echo "ðŸš€ **Services:** Restarted" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŒ **Cloudflare:** Cache purged" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status:** Failed" >> $GITHUB_STEP_SUMMARY
            echo "Check logs for details" >> $GITHUB_STEP_SUMMARY
          fi
