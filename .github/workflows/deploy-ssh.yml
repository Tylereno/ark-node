name: Deploy ARK via SSH (Recommended)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy-ssh:
    name: Deploy via SSH (Recommended for Docker)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Tailscale
        uses: tailscale/github-action@v3
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:github-actions  # <--- Make sure this matches your ACL!

      - name: Wait for Tailscale to be ready
        run: |
          echo "Waiting for Tailscale connection to stabilize..."
          sleep 10
          echo "=== Tailscale Status ==="
          tailscale status || (echo "âŒ Tailscale status check failed" && exit 1)
          echo ""
          echo "=== Tailscale IP ==="
          TS_IP=$(tailscale ip -4) || (echo "âŒ Failed to get Tailscale IP" && exit 1)
          echo "GitHub Actions Tailscale IP: $TS_IP"
          echo ""
          echo "=== Testing connectivity to server ==="
          ping -c 3 100.124.104.38 || (echo "âŒ Cannot ping server" && exit 1)
          echo "âœ… Connectivity test passed"

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # Deploy using standard SSH key authentication over Tailscale network tunnel
      # Tailscale is only used for network connectivity, NOT for SSH authentication
      # This bypasses Tailscale SSH policies and uses standard SSH keys
      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}  # Should be 100.124.104.38 (Tailscale IP - persistent)
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}  # Standard SSH key, not Tailscale SSH
          port: ${{ secrets.SSH_PORT || 22 }}
          envs: GITHUB_SHA
          script_stop: true
          debug: true  # Show detailed SSH connection logs
          proxy_timeout: 30s
          command_timeout: 60m  # Give it 1 hour for large Docker image pulls (Ollama is 8.97GB)
          script: |
            set -e
            cd /opt/ark
            
            echo "=== ARK Deployment Started ==="
            echo "Time: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            echo ""
            
            # Create .env file from GitHub Secrets
            echo "Creating .env file from secrets..."
            cat > .env << 'ENVEOF'
            # Auto-generated .env file from GitHub Secrets
            # Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
            
            # Network Configuration
            ARK_NODE_IP=${{ secrets.ARK_NODE_IP }}
            ARK_DOMAIN=${{ secrets.ARK_DOMAIN }}
            
            # Default Credentials
            ARK_ADMIN_USER=${{ secrets.ARK_ADMIN_USER }}
            ARK_ADMIN_PASSWORD=${{ secrets.ARK_ADMIN_PASSWORD }}
            
            # Service Credentials
            FILEBROWSER_ADMIN_TOKEN=${{ secrets.FILEBROWSER_ADMIN_TOKEN }}
            CODE_SERVER_PASSWORD=${{ secrets.CODE_SERVER_PASSWORD }}
            CODE_SERVER_SUDO_PASSWORD=${{ secrets.CODE_SERVER_SUDO_PASSWORD }}
            
            # Tailscale (Optional)
            TAILSCALE_AUTHKEY=${{ secrets.TAILSCALE_AUTHKEY }}
            
            # Timezone
            TZ=${{ secrets.TZ || 'America/Los_Angeles' }}
            
            # DO NOT EDIT - Auto-generated by GitHub Actions
            ENVEOF
            
            # Pull latest code from GitHub (respects .gitignore automatically)
            echo "Pulling latest code from GitHub..."
            git fetch origin main || echo "âš  Git fetch failed, continuing..."
            git reset --hard origin/main || echo "âš  Git reset failed, continuing..."
            
            echo "âœ“ Code synced from GitHub"
            echo "âœ“ .env file created"
            
            # Load environment variables
            if [ -f .env ]; then
              echo "Loading environment variables..."
              source .env
            else
              echo "âš  Warning: .env file not found"
            fi
            
            # Pull latest Docker images (quiet mode to keep connection stable)
            echo ""
            echo "Pulling latest Docker images (this may take 10-20 minutes for large images like Ollama)..."
            docker compose pull -q || echo "âš  Some images failed to pull, continuing..."
            
            # Restart services
            echo "Restarting services..."
            docker compose up -d --force-recreate --remove-orphans
            
            # Note: Ollama models are stored in /mnt/dock/data/models (persistent volume)
            # They don't need to be re-downloaded on each deployment
            
            # Wait for services to stabilize
            echo "Waiting for services to stabilize..."
            sleep 15
            
            # Health check
            echo ""
            echo "=== Service Status ==="
            docker compose ps
            
            # Verify critical services
            echo ""
            echo "=== Health Check ==="
            RUNNING=$(docker compose ps --format json 2>/dev/null | grep -c '"State":"running"' || echo "0")
            TOTAL=$(docker compose ps --format json 2>/dev/null | grep -c '"Name"' || echo "0")
            
            if [ "$RUNNING" -eq "$TOTAL" ] && [ "$TOTAL" -gt "0" ]; then
              echo "âœ… All $TOTAL services running"
            else
              echo "âš  Status: $RUNNING/$TOTAL services running"
              echo "Check logs: docker compose logs"
            fi
            
            # Log deployment
            echo "$(date -u +"%Y-%m-%d %H:%M:%S UTC") - GitHub Actions deployment completed" >> /opt/ark/.deploy.log
            
            echo ""
            echo "=== Deployment Complete ==="

      - name: Purge Cloudflare Cache
        if: success()
        uses: jakejarvis/cloudflare-purge-action@master
        env:
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        with:
          purge: 'everything'

      - name: Deployment Summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… **Status:** Success" >> $GITHUB_STEP_SUMMARY
            echo "ðŸš€ **Services:** Restarted" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŒ **Cloudflare:** Cache purged" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status:** Failed" >> $GITHUB_STEP_SUMMARY
            echo "Check logs for details" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Common Issues:**" >> $GITHUB_STEP_SUMMARY
            echo "- SSH key not in GitHub Secrets" >> $GITHUB_STEP_SUMMARY
            echo "- Public key not in server's ~/.ssh/authorized_keys" >> $GITHUB_STEP_SUMMARY
            echo "- Firewall blocking port 22" >> $GITHUB_STEP_SUMMARY
            echo "- SSH key has passphrase (must be empty)" >> $GITHUB_STEP_SUMMARY
          fi
