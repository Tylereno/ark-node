name: Deploy ARK via SSH (Recommended)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy-ssh:
    name: Deploy via SSH (Recommended for Docker)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Tailscale
        uses: tailscale/github-action@v3
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:github-actions  # <--- Make sure this matches your ACL!

      - name: Wait for Tailscale to be ready
        run: |
          echo "Waiting for Tailscale connection to stabilize..."
          sleep 10
          echo "=== Tailscale Status ==="
          tailscale status || (echo "âŒ Tailscale status check failed" && exit 1)
          echo ""
          echo "=== Tailscale IP ==="
          TS_IP=$(tailscale ip -4) || (echo "âŒ Failed to get Tailscale IP" && exit 1)
          echo "GitHub Actions Tailscale IP: $TS_IP"
          echo ""
          echo "=== Testing connectivity to server ==="
          ping -c 3 100.124.104.38 || (echo "âŒ Cannot ping server" && exit 1)
          echo "âœ… Connectivity test passed"

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # Deploy using standard SSH key authentication over Tailscale network tunnel
      # Tailscale is only used for network connectivity, NOT for SSH authentication
      # This bypasses Tailscale SSH policies and uses standard SSH keys
      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}  # Should be 100.124.104.38 (Tailscale IP - persistent)
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}  # Standard SSH key, not Tailscale SSH
          port: ${{ secrets.SSH_PORT || 22 }}
          envs: GITHUB_SHA
          script_stop: true
          debug: true  # Show detailed SSH connection logs
          proxy_timeout: 30s
          command_timeout: 60m  # Give it 1 hour for large Docker image pulls (Ollama is 8.97GB)
          script: |
            cd /opt/ark
            
            echo "=== ARK Deployment Started ==="
            echo "Time: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            echo "Source: GitHub Actions"
            echo ""
            
            # Create .env file from GitHub Secrets
            echo "Creating .env file from secrets..."
            cat > .env << 'ENVEOF'
            # Auto-generated .env file from GitHub Secrets
            # Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
            
            # Network Configuration
            ARK_NODE_IP=${{ secrets.ARK_NODE_IP }}
            ARK_DOMAIN=${{ secrets.ARK_DOMAIN }}
            
            # Default Credentials
            ARK_ADMIN_USER=${{ secrets.ARK_ADMIN_USER }}
            ARK_ADMIN_PASSWORD=${{ secrets.ARK_ADMIN_PASSWORD }}
            
            # Service Credentials
            FILEBROWSER_ADMIN_TOKEN=${{ secrets.FILEBROWSER_ADMIN_TOKEN }}
            CODE_SERVER_PASSWORD=${{ secrets.CODE_SERVER_PASSWORD }}
            CODE_SERVER_SUDO_PASSWORD=${{ secrets.CODE_SERVER_SUDO_PASSWORD }}
            
            # Tailscale (Optional)
            TAILSCALE_AUTHKEY=${{ secrets.TAILSCALE_AUTHKEY }}
            
            # Timezone
            TZ=${{ secrets.TZ || 'America/Los_Angeles' }}
            
            # DO NOT EDIT - Auto-generated by GitHub Actions
            ENVEOF
            
            echo "âœ“ .env file created"
            echo ""
            
            # Load environment variables
            if [ -f .env ]; then
              echo "Loading environment variables..."
              source .env
            fi
            
            # Execute Ralph Loop via ark-manager.sh
            # This ensures GitHub Actions and local scripts use the same code
            echo "=== Executing Ralph Loop via ARK Manager ==="
            echo ""
            /opt/ark/scripts/ark-manager.sh loop || {
              echo "âš  Ralph Loop had issues, but continuing..."
              # Fallback: basic deployment
              docker compose pull -q || true
              docker compose up -d --remove-orphans || true
            }
            
            # Auto-cleanup root folder to prevent clutter
            echo ""
            echo "=== Auto-cleaning root folder ==="
            /opt/ark/scripts/auto-cleanup.sh || echo "âš  Auto-cleanup had issues, continuing..."
            
            # Final line ensures the script exits with success (0)
            exit 0

      - name: Deployment Summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… **Status:** Success" >> $GITHUB_STEP_SUMMARY
            echo "ðŸš€ **Services:** All 16 services running" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŒ **Deployment:** Complete via Tailscale tunnel" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status:** Failed" >> $GITHUB_STEP_SUMMARY
            echo "Check logs for details" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Common Issues:**" >> $GITHUB_STEP_SUMMARY
            echo "- SSH key not in GitHub Secrets" >> $GITHUB_STEP_SUMMARY
            echo "- Public key not in server's ~/.ssh/authorized_keys" >> $GITHUB_STEP_SUMMARY
            echo "- Firewall blocking port 22" >> $GITHUB_STEP_SUMMARY
            echo "- SSH key has passphrase (must be empty)" >> $GITHUB_STEP_SUMMARY
          fi
